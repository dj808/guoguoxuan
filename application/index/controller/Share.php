<?phpnamespace app\index\controller;use think\Db;use think\Exception;use think\Request;use think\Response;use think\Controller;use think\Image;/** * 前端首页控制器 * Class Index * @package app\index\controller */class Share extends Controller{    /**     * 分享功能的实现     */    public function index(){        $userId=$this->request->param('user_id');        $data=Db::name('share_num')->field('id,qrcode')->where('user_id',$userId)->find();        if($data['qrcode']){            $this->view->assign('data',$data);        }else{            header('Content-Type: image/png');            vendor("phpqrcode.phpqrcode");//引入工具包            $qRcode = new \QRcode();            $path = "public/Uploads/QRcode/";//生成的二维码所在目录            $time=time().'.png';            $fileName=$path.$time;            $data='http://guoguo.loungwangtouzi.com/index/index/index?user_id='.$userId;            $level='L';            $size=11;            ob_end_clean();//清空缓冲区            $qRcode::png($data,$fileName,$level, $size);			session('imgpath',$fileName);            $file_name = iconv("utf-8","gb2312",$time);            $file_path = $_SERVER['DOCUMENT_ROOT'].'/'.$fileName; //获取下载文件的大小            $file_size = filesize($file_path); //            $file_temp = fopen ( $file_path, "r" ); //返回的文件            header("Content-type:application/octet-stream"); //按照字节大小返回            header("Accept-Ranges:bytes"); //返回文件大小            header("Accept-Length:".$file_size); //这里客户端的弹出对话框            header("Content-Disposition:attachment;filename=".$time);		     $path_1 = "http://guoguo.loungwangtouzi.com/public/static/index/images/share.jpg";			 $path_2 = "http://guoguo.loungwangtouzi.com/".session('imgpath');			 $image_1 = imagecreatefromjpeg($path_1);             $image_2 = imagecreatefrompng($path_2);             $image_3 = imageCreatetruecolor(imagesx($image_1),imagesy($image_1));            $color = imagecolorallocate($image_3, 255, 255, 255);            imagefill($image_3, 0, 0, $color);            imageColorTransparent($image_3, $color);            imagecopyresampled($image_3,$image_1,0,0,0,0,imagesx($image_1),imagesy($image_1),imagesx($image_1),imagesy($image_1));            imagecopymerge($image_3,$image_2,135,540,0,0,imagesx($image_2),imagesy($image_2), 100);            //将画布保存到指定的gif文件            $fn='public/Uploads/QRcode/'.time().'.jpg';            // $im= '/Uploads/QRcode/'.$time;               imagejpeg($image_3, $fn);			 			 $info['qrcode']=$fn;			 $info['user_id']=$userId;			 $info['create_time']=time();            Db::name('share_num')->insert($info);            $this->view->assign('data',$info);        }        return  $this->view->fetch();    }}